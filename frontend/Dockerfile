# ---------- build stage ---------- #
FROM --platform=$BUILDPLATFORM node:20-bookworm-slim AS build
WORKDIR /app

# --- ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« --------------------------------------------------- #
# package.json / lock-file ã ã‘å…ˆã«ã‚³ãƒ”ãƒ¼ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
COPY package.json package-lock.json* ./

# å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm ci --include=optional \
 && if [ "$(uname -m)" = "aarch64" ]; then \
        npm i --no-save @rollup/rollup-linux-arm64-gnu; \
    fi \
 && npm cache clean --force

# --- ã‚¢ãƒ—ãƒªã‚½ãƒ¼ã‚¹ ------------------------------------------------------- #
COPY . .

# ãƒ“ãƒ«ãƒ‰ (Vite) â€“ react-split-pane-next è¿½åŠ å¾Œã¯æˆåŠŸã™ã‚‹
RUN npm run build   # vite build now succeeds ğŸ‰

# ---------- runtime stage ---------- #
FROM nginx:1.26-alpine
LABEL org.opencontainers.image.source="https://github.com/your-org/ne-navi"

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’é…ç½®
COPY --from=build /app/dist /usr/share/nginx/html

HEALTHCHECK CMD wget -qO- http://localhost/ || exit 1
